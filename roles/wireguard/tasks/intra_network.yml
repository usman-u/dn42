---
# Build intra-network WireGuard configuration for this host

- name: Initialize intra-network WireGuard configs
  set_fact:
    wireguard_intra_network_configs: []
    wireguard_intra_network_interfaces: []

- name: Build intra-network tunnel configs
  set_fact:
    wireguard_intra_network_configs: "{{ wireguard_intra_network_configs + [tunnel_config] }}"
    wireguard_intra_network_interfaces: "{{ wireguard_intra_network_interfaces + [interface_name] }}"
  vars:
    router_a: "{{ item.routers[0] }}"
    router_b: "{{ item.routers[1] }}"
    # Determine if we're router_a or router_b
    is_router_a: "{{ inventory_hostname == router_a }}"
    peer_router: "{{ router_b if is_router_a else router_a }}"

    # Extract location codes (e.g., lhr-r001 -> lhr, ewr-r001 -> ewr)
    # WireGuard interface names can't have numbers after letters
    location_a: "{{ router_a.split('-')[0] }}"
    location_b: "{{ router_b.split('-')[0] }}"

    # Generate interface name using just location codes
    interface_name: "wg-{{ [location_a, location_b] | sort | join('-') }}"

    # Generate addresses from loopbacks
    my_loopback_last: "{{ loopback.split('.')[-1] }}"
    peer_loopback_last: "{{ hostvars[peer_router].loopback.split('.')[-1] }}"
    # IPv4 link-local for OSPF + IPv6 link-local for iBGP
    # Use sorted router IDs to ensure consistent /30 pairing: lower gets .1, higher gets .2
    router_ids_sorted: "{{ [my_loopback_last | int, peer_loopback_last | int] | sort }}"
    my_ip_offset: "{{ 1 if (my_loopback_last | int) == (router_ids_sorted[0] | int) else 2 }}"
    # Use sum of both IDs for the third octet to make each tunnel unique
    ip_third_octet: "{{ ((my_loopback_last | int) + (peer_loopback_last | int)) % 256 }}"
    # IPv6: Use the tunnel's third octet to make each tunnel unique
    my_wg_address: "169.254.{{ ip_third_octet }}.{{ my_ip_offset }}/30, fe80::1869:{{ '%02x' | format(ip_third_octet | int) }}{{ my_ip_offset }}/64"

    # Generate port if "auto"
    calculated_port: "{{ (5000 + (my_loopback_last | int) + (peer_loopback_last | int)) if item.port == 'auto' else item.port }}"

    tunnel_config:
      interface_name: "{{ interface_name }}"
      privkey: "{{ wg_privkey }}"
      address: "{{ my_wg_address }}"
      listenport: "{{ calculated_port }}"
      peer_pubkey: "{{ hostvars[peer_router].wg_pubkey }}"
      peer_endpoint: "{{ hostvars[peer_router].wan_ip + ':' + (calculated_port | string) }}"
  loop: "{{ intra_network_tunnels | default([]) }}"
  when:
    - intra_network_tunnels is defined
    - inventory_hostname in item.routers
    - item.port is defined  # Skip GRE tunnels (they don't have a port field)

- name: Debug intra-network WireGuard configs
  debug:
    var: wireguard_intra_network_configs
  when: wireguard_intra_network_configs is defined and (wireguard_intra_network_configs | length > 0)
