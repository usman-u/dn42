---
# Netplan role: Manage network configuration

- name: Check if netplan is installed
  command: which netplan
  register: netplan_check
  failed_when: false
  changed_when: false

- name: Install netplan.io
  apt:
    name: netplan.io
    state: present
  when: netplan_check.rc != 0

- name: Gather current netplan configuration
  slurp:
    src: /etc/netplan/50-cloud-init.yaml
  register: current_netplan
  failed_when: false
  changed_when: false

- name: Generate netplan configuration
  template:
    src: netplan.yaml.j2
    dest: /etc/netplan/50-cloud-init.yaml
    mode: '0600'
    owner: root
    group: root
    backup: true
  notify: apply netplan
  when: netplan_config is defined

- name: Validate netplan configuration
  command: netplan generate
  register: netplan_validate
  changed_when: false
  failed_when: netplan_validate.rc != 0
