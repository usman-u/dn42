---
# Main playbook for DN42 router configuration
# This playbook is idempotent and handles both initial setup and ongoing configuration
- name: Configure DN42 routers
  hosts: routers
  gather_facts: true
  become: true

  pre_tasks:
    - name: Display deployment mode
      debug:
        msg: "{{ 'DRY-RUN MODE - No changes will be applied' if ansible_check_mode else 'APPLY MODE - Changes will be applied' }}"

    - name: Ensure we're running on a supported OS
      assert:
        that:
          - ansible_distribution in ["Ubuntu", "Debian"]
        fail_msg: "This playbook only supports Ubuntu and Debian. Found: {{ ansible_distribution }}"

    - name: Display router information
      debug:
        msg: |
          Router: {{ inventory_hostname }} | {{ loopback }} | ASN: {{ dn42_asn }} | Peers: {{ peers | default([]) | length }}

  roles:
    - role: common
      tags: ['common', 'base']

    - role: network
      tags: ['network']
      when: network_config is defined

    - role: wireguard
      tags: ['wireguard', 'wg']

    - role: frr
      tags: ['frr', 'bgp', 'routing']

  post_tasks:
    - name: Display summary
      debug:
        msg: |-

          âœ“ Configuration complete for {{ inventory_hostname }}

          Next steps:
          {% if ansible_check_mode %}
          - Review the diff output above
          - Run with --apply to apply changes
          {% else %}
          - Check BGP status: sudo vtysh -c "show bgp summary"
          - Check WireGuard: wg show
          - Check routes: sudo vtysh -c "show ip route"
          {% endif %}
