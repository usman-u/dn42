---
# Global DN42 BGP Configuration
dn42_asn: 4242421869

# WireGuard Global Defaults
wg_defaults:
  table: "off"
  persistent_keepalive: 25
  allowed_ips: "0.0.0.0/0, ::/0"

# BGP Community Lists
bgp_community_lists:
  - name: CL-DN42-DE
    seq: 5
    value: "64511:1276"
  - name: CL-DN42-EUROPE
    seq: 5
    value: "64511:41"
  - name: CL-DN42-GB
    seq: 5
    value: "64511:1826"

# BGP AS Path ACLs
bgp_as_path_acls:
  - name: AS_PATH_LEN_1
    seq: 5
    value: "^[0-9]+$"

# IP Prefix Lists
ip_prefix_lists:
  - name: DN42-ALL
    seq: 5
    action: permit
    prefix: "172.20.0.0/14"
    ge: 14
    le: 32
  - name: PL-INTERLINKS
    seq: 5
    action: permit
    prefix: "169.254.0.0/16"
    ge: 30
    le: 31

# IPv6 Prefix Lists
ipv6_prefix_lists:
  - name: DN42-ALL-V6
    seq: 5
    action: permit
    prefix: "fd00::/8"
    ge: 8
    le: 128

# BGP Large Community Lists
bgp_large_community_lists:
  - name: LCL-USMAN-NATIVE
    seq: 10
    value: "4242421869:100:1"
  - name: LCL-USMAN-TRANSIT
    seq: 10
    value: "4242421869:100:2"
  - name: LCL-USMAN-EXPORT
    seq: 10
    value: "4242421869:100:[1-2]"



# Intra-network GRE tunnels (for iBGP + OSPF + MPLS/LDP)
# GRE is required for MPLS - as WireGuard cannot carry MPLS labels (no L2 header)
intra_network_tunnels:
  - routers: [lhr-r001, ewr-r001]
    ospf_cost: 78
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_lhr_ewr }}"
  - routers: [ewr-r001, lax-r001]
    ospf_cost: 58
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_ewr_lax }}"
  - routers: [lhr-r001, frk-r001]
    ospf_cost: 15
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_lhr_frk }}"
  - routers: [lhr-r001, sgx-r001]
    ospf_cost: 170
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_lhr_sgx }}"
  - routers: [frk-r001, sgx-r001]
    ospf_cost: 160
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_frk_sgx }}"
  - routers: [sgx-r001, lax-r001]
    ospf_cost: 150
    mtu: 1400
    encryption: gre_key
    gre_key: "{{ vault_gre_key_sgx_lax }}"

# iBGP Configuration - Full Mesh
ibgp_enabled: true
ibgp_config:
  timers:
    keepalive: 2
    holdtime: 10
  route_reflector_enabled: false
  bfd_enabled: false

  # iBGP Peer Group Configuration
  peer_group:
    name: "IBGP-MESH"
    remote_as: "{{ dn42_asn }}"
    next_hop_self: true
    address_families:
      ipv4_unicast: true
      ipv6_unicast: false  # Disabled: loopbacks are IPv4-only
    soft_reconfiguration_inbound: true

# iBGP full mesh
ibgp_mesh:
  - lhr-r001
  - ewr-r001
  - lax-r001
  - frk-r001
  - sgx-r001

# IS-IS Configuration
# NOTE: IS-IS cannot work over WireGuard (Layer 2 vs Layer 3 incompatibility)
# WireGuard uses TUN devices (L3 only), IS-IS requires pfpacket (L2 frames)
# isis_enabled: false
# isis_config:
#   area_id: "49"
#   is_type: "level-2-only"
#   metric_style: "wide"
#   circuit_type: "level-2-only"

# OSPF Configuration (working - IS-IS incompatible with WireGuard)
ospf_enabled: true
ospf_config:
  area_id: "0.0.0.0"  # Backbone area
  reference_bandwidth: 100000  # 100 Gbps for proper cost calculation
  log_adjacency_changes: true
  hello_interval: 1
  dead_interval: 10
  redistribute:
    - type: connected
      route_map: RM-REDIST-INTERLINKS

# # Segment Routing Configuration
# segment_routing_enabled: true
# segment_routing_config:
#   # Segment Routing Global Block (MUST be identical on all routers)
#   # Defines the MPLS label range: actual_label = srgb_start + prefix_sid_index
#   srgb_start: 16000
#   srgb_end: 23999
#   # Maximum SID Depth (max labels in stack)
#   node_msd: 16
#   # Use explicit-null labels (better for traceroute)
#   explicit_null: true
#   # Prefix SID index calculation method:
#   #   "last_octet": Use last octet of loopback (e.g., 172.22.132.161 → index 161 → label 16161)
#   #   "manual": Specify index manually in host_vars (segment_routing_index)
#   index_method: "last_octet"

# Static Routes
static_routes:
  - destination: "172.22.132.160/27"
    nexthop: "Null0"
    description: "DN42 network prefix null route"

# Route Maps (non-peer specific)
route_maps:
  - name: RM-DN42-RANGE-ORIGIN
    seq: 10
    action: permit
    set_community: "64511:41 64511:1826"
    set_large_community: "4242421869:100:1"

  - name: RM-PERMIT-ALL
    seq: 10
    action: permit

  - name: RM-DN42-PEER-OUT
    entries:
      - seq: 10
        action: permit
        match_prefix_list: DN42-ALL
        match_large_community: LCL-USMAN-EXPORT
      - seq: 500
        action: deny

  - name: RM-DN42-PEER-OUT-V6
    entries:
      - seq: 10
        action: permit
        match_ipv6_prefix_list: DN42-ALL-V6
        match_large_community: LCL-USMAN-EXPORT
      - seq: 500
        action: deny

  - name: RM-REDIST-INTERLINKS
    entries:
      - seq: 10
        action: permit
        match_prefix_list: PL-INTERLINKS
      - seq: 500
        action: deny
