---
# FRR role: Manage FRRouting BGP daemon

- name: Build iBGP peer list
  include_tasks: build_ibgp_peers.yml
  when: ibgp_enabled | default(false)

- name: Build intra-network WireGuard configs for FRR
  include_tasks: ../wireguard/tasks/intra_network.yml
  when: intra_network_tunnels is defined

- name: Build GRE tunnel configs for FRR
  set_fact:
    frr_gre_tunnel_configs: "{{ frr_gre_tunnel_configs | default([]) + [tunnel_config] }}"
  vars:
    router_a: "{{ item.routers[0] }}"
    router_b: "{{ item.routers[1] }}"
    is_router_a: "{{ inventory_hostname == router_a }}"
    peer_router: "{{ router_b if is_router_a else router_a }}"
    location_a: "{{ router_a.split('-')[0] }}"
    location_b: "{{ router_b.split('-')[0] }}"
    interface_name: "gre-{{ [location_a, location_b] | sort | join('-') }}"
    my_loopback_last: "{{ loopback.split('.')[-1] }}"
    peer_loopback_last: "{{ hostvars[peer_router].loopback.split('.')[-1] }}"
    router_ids_sorted: "{{ [my_loopback_last | int, peer_loopback_last | int] | sort }}"
    my_ip_offset: "{{ 1 if (my_loopback_last | int) == (router_ids_sorted[0] | int) else 2 }}"
    ip_third_octet: "{{ ((my_loopback_last | int) + (peer_loopback_last | int)) % 256 }}"
    my_gre_address: "169.254.{{ ip_third_octet }}.{{ my_ip_offset }}/30"
    tunnel_config:
      interface_name: "{{ interface_name }}"
      tunnel_address: "{{ my_gre_address }}"
      ospf_cost: "{{ item.ospf_cost | default(10) }}"
  loop: "{{ intra_network_tunnels | default([]) }}"
  when:
    - intra_network_tunnels is defined
    - inventory_hostname in item.routers
    - item.encryption is defined  # GRE tunnels have encryption field

- name: Install FRR
  apt:
    name:
      - frr
      - frr-pythontools
    state: present
    update_cache: true

- name: Enable FRR daemons
  template:
    src: daemons.j2
    dest: /etc/frr/daemons
    mode: '0640'
    owner: frr
    group: frr
    backup: true
  notify: restart frr

- name: Configure vtysh
  template:
    src: vtysh.conf.j2
    dest: /etc/frr/vtysh.conf
    mode: '0640'
    owner: frr
    group: frr
  notify: restart frr

- name: Get current FRR running configuration (before)
  shell: vtysh -c "show running-config"
  register: frr_running_config_before
  changed_when: false
  failed_when: false

- name: Get BGP summary before configuration change
  shell: vtysh -c "show ip bgp summary"
  register: bgp_summary_before
  changed_when: false
  failed_when: false

- name: Generate FRR configuration
  template:
    src: frr.conf.j2
    dest: /etc/frr/frr.conf
    mode: '0640'
    owner: frr
    group: frr
    backup: true
    validate: 'vtysh --dryrun --inputfile %s'
  notify: reload frr config
  register: frr_config

- name: Ensure FRR service is enabled and started
  when: not ansible_check_mode
  systemd:
    name: frr
    enabled: true
    state: started

- name: Wait for FRR to stabilize after config change
  wait_for:
    timeout: 5
  when: frr_config is changed

- name: Get current FRR running configuration (after)
  shell: vtysh -c "show running-config"
  register: frr_running_config_after
  changed_when: false
  failed_when: false

- name: Get BGP summary after configuration change
  shell: vtysh -c "show ip bgp summary"
  register: bgp_summary_after
  changed_when: false
  failed_when: false

- name: Compare FRR running configurations
  set_fact:
    frr_config_changed: "{{ frr_running_config_before.stdout != frr_running_config_after.stdout }}"
  when:
    - frr_running_config_before.rc == 0
    - frr_running_config_after.rc == 0

- name: Write running configs to temp files for diff
  copy:
    content: "{{ item.content }}"
    dest: "/tmp/frr_{{ item.name }}_{{ inventory_hostname }}.conf"
  loop:
    - { name: 'before', content: "{{ frr_running_config_before.stdout }}" }
    - { name: 'after', content: "{{ frr_running_config_after.stdout }}" }
  when:
    - frr_running_config_before.rc == 0
    - frr_running_config_after.rc == 0
    - frr_running_config_before.stdout != frr_running_config_after.stdout
  changed_when: false

- name: Generate diff of FRR running config changes
  shell: diff -u /tmp/frr_before_{{ inventory_hostname }}.conf /tmp/frr_after_{{ inventory_hostname }}.conf || true
  register: frr_config_diff
  when:
    - frr_running_config_before.rc == 0
    - frr_running_config_after.rc == 0
    - frr_running_config_before.stdout != frr_running_config_after.stdout
  changed_when: false

- name: Display FRR configuration changes
  debug:
    msg: "{{ ['⚠️  FRR CONFIGURATION CHANGES DETECTED', ''] + frr_config_diff.stdout_lines }}"
  when:
    - frr_running_config_before.rc == 0
    - frr_running_config_after.rc == 0
    - frr_running_config_before.stdout != frr_running_config_after.stdout

- name: Compare BGP peering states
  set_fact:
    bgp_changed: "{{ bgp_summary_before.stdout != bgp_summary_after.stdout }}"
  when: bgp_summary_before.rc == 0 and bgp_summary_after.rc == 0

- name: Display BGP peering changes header
  debug:
    msg: "⚠️  BGP PEERING CHANGES DETECTED"
  when:
    - bgp_summary_before.rc == 0
    - bgp_summary_after.rc == 0
    - bgp_summary_before.stdout != bgp_summary_after.stdout

- name: Display BGP summary BEFORE
  debug:
    msg: "{{ bgp_summary_before.stdout_lines }}"
  when:
    - bgp_summary_before.rc == 0
    - bgp_summary_after.rc == 0
    - bgp_summary_before.stdout != bgp_summary_after.stdout

- name: Display BGP summary AFTER
  debug:
    msg: "{{ bgp_summary_after.stdout_lines }}"
  when:
    - bgp_summary_before.rc == 0
    - bgp_summary_after.rc == 0
    - bgp_summary_before.stdout != bgp_summary_after.stdout

- name: Display FRR status (no config changes)
  debug:
    msg: "✓ FRR Running Configuration Unchanged"
  when:
    - frr_running_config_before.rc == 0
    - frr_running_config_after.rc == 0
    - frr_running_config_before.stdout == frr_running_config_after.stdout

- name: Display BGP status (no changes)
  debug:
    msg: "{{ ['✓ BGP Peerings Unchanged', ''] + bgp_summary_after.stdout_lines }}"
  when:
    - bgp_summary_before.rc == 0
    - bgp_summary_after.rc == 0
    - bgp_summary_before.stdout == bgp_summary_after.stdout
