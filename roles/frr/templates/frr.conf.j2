frr version 8.4.4
frr defaults traditional
hostname {{ inventory_hostname }}
log syslog informational
service integrated-vtysh-config
!
{% if static_routes is defined %}
{% for route in static_routes %}
ip route {{ route.destination }} {{ route.nexthop }}
{% endfor %}
!
{% endif %}
interface lo
 ip address {{ loopback }}/32
{% if isis_enabled | default(false) %}
 ip router isis DN42
 ipv6 router isis DN42
{% endif %}
{% if ospf_enabled | default(false) %}
 ip ospf area {{ ospf_config.area_id | default('0.0.0.0') }}
{% endif %}
exit
!
{% if isis_enabled | default(false) and intra_network_wg_configs is defined %}
{% for wg in intra_network_wg_configs %}
interface {{ wg.interface_name }}
 ip address {{ wg.address.split(',')[0].strip() }}
 ipv6 address {{ wg.address.split(',')[1].strip() }}
 ip router isis DN42
 ipv6 router isis DN42
 isis network point-to-point
 isis circuit-type {{ isis_config.circuit_type | default('level-2-only') }}
exit
!
{% endfor %}
{% endif %}
{% if ospf_enabled | default(false) and intra_network_wg_configs is defined %}
{% for wg in intra_network_wg_configs %}
interface {{ wg.interface_name }}
 ip address {{ wg.address.split(',')[0].strip() }}
 ipv6 address {{ wg.address.split(',')[1].strip() }}
 ip ospf area {{ ospf_config.area_id | default('0.0.0.0') }}
 ip ospf network point-to-point
{% if ospf_config.hello_interval is defined %}
 ip ospf hello-interval {{ ospf_config.hello_interval }}
{% endif %}
{% if ospf_config.dead_interval is defined %}
 ip ospf dead-interval {{ ospf_config.dead_interval }}
{% endif %}
exit
!
{% endfor %}
{% endif %}
router bgp {{ dn42_asn }}
 bgp router-id {{ bgp_router_id | default(loopback) }}
{% if bgp_options is defined %}
{% for option in bgp_options %}
 {{ option }}
{% endfor %}
{% endif %}
{% if ibgp_enabled | default(false) and ibgp_config.peer_group is defined %}
 !
 ! iBGP Peer Group Configuration
 neighbor {{ ibgp_config.peer_group.name }} peer-group
 neighbor {{ ibgp_config.peer_group.name }} remote-as {{ dn42_asn }}
{% if ibgp_config.peer_group.next_hop_self | default(false) %}
 neighbor {{ ibgp_config.peer_group.name }} next-hop-self
{% endif %}
{% if ibgp_config.timers is defined %}
 neighbor {{ ibgp_config.peer_group.name }} timers {{ ibgp_config.timers.keepalive }} {{ ibgp_config.timers.holdtime }}
{% endif %}
{% if ibgp_config.bfd_enabled | default(false) %}
 neighbor {{ ibgp_config.peer_group.name }} bfd
{% endif %}
{% if ibgp_config.peer_group.soft_reconfiguration_inbound | default(false) %}
 neighbor {{ ibgp_config.peer_group.name }} soft-reconfiguration inbound
{% endif %}
 !
{% endif %}
{% if bgp_peers is defined %}
{% for peer in bgp_peers %}
 neighbor {{ peer.neighbor }} remote-as {{ peer.remote_as }}
{% if peer.description is defined %}
 neighbor {{ peer.neighbor }} description {{ peer.description }}
{% endif %}
{% endfor %}
{% endif %}
{% if ibgp_enabled | default(false) and intra_network_ibgp_peers is defined %}
{% for ibgp_peer in intra_network_ibgp_peers %}
 ! iBGP peer: {{ ibgp_peer.name }}
 neighbor {{ ibgp_peer.loopback }} peer-group {{ ibgp_config.peer_group.name }}
 neighbor {{ ibgp_peer.loopback }} description iBGP-{{ ibgp_peer.name }}
 neighbor {{ ibgp_peer.loopback }} update-source {{ loopback }}
{% endfor %}
{% endif %}
{% if peers is defined %}
{% for peer in peers %}
 neighbor {{ peer.peer_address }} remote-as {{ peer.asn }}
 neighbor {{ peer.peer_address }} description {{ peer.name }}
 neighbor {{ peer.peer_address }} interface wg{{ peer.asn }}
 neighbor {{ peer.peer_address }} timers 1 5
 neighbor {{ peer.peer_address }} capability extended-nexthop
{% endfor %}
{% endif %}
 !
 address-family ipv4 unicast
{% if bgp_networks is defined and bgp_networks.ipv4 is defined %}
{% for network in bgp_networks.ipv4 %}
  network {{ network.prefix }}{% if network.route_map is defined %} route-map {{ network.route_map }}{% endif %}

{% endfor %}
{% endif %}
{% if ibgp_enabled | default(false) and intra_network_ibgp_peers is defined and ibgp_config.peer_group.address_families.ipv4_unicast | default(false) %}
  ! Activate iBGP neighbors for IPv4
{% for ibgp_peer in intra_network_ibgp_peers %}
  neighbor {{ ibgp_peer.loopback }} activate
{% if ibgp_config.peer_group.next_hop_self | default(false) %}
  neighbor {{ ibgp_peer.loopback }} next-hop-self
{% endif %}
{% if ibgp_config.peer_group.soft_reconfiguration_inbound | default(false) %}
  neighbor {{ ibgp_peer.loopback }} soft-reconfiguration inbound
{% endif %}
{% endfor %}
{% endif %}
{% if bgp_peers is defined %}
{% for peer in bgp_peers %}
{% if peer.ipv4 is defined and peer.ipv4.enabled is defined and peer.ipv4.enabled %}
{% if peer.ipv4.route_map_in is defined %}
  neighbor {{ peer.neighbor }} route-map {{ peer.ipv4.route_map_in }} in
{% endif %}
{% if peer.ipv4.route_map_out is defined %}
  neighbor {{ peer.neighbor }} route-map {{ peer.ipv4.route_map_out }} out
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
{% if peers is defined %}
{% for peer in peers %}
  neighbor {{ peer.peer_address }} soft-reconfiguration inbound
  neighbor {{ peer.peer_address }} route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN in
  neighbor {{ peer.peer_address }} route-map RM-DN42-PEER-OUT out
{% endfor %}
{% endif %}
 exit-address-family
 !
 address-family ipv6 unicast
{% if ibgp_enabled | default(false) and intra_network_ibgp_peers is defined and ibgp_config.peer_group.address_families.ipv6_unicast | default(false) %}
  ! Activate iBGP neighbors for IPv6
{% for ibgp_peer in intra_network_ibgp_peers %}
  neighbor {{ ibgp_peer.loopback }} activate
{% if ibgp_config.peer_group.next_hop_self | default(false) %}
  neighbor {{ ibgp_peer.loopback }} next-hop-self
{% endif %}
{% if ibgp_config.peer_group.soft_reconfiguration_inbound | default(false) %}
  neighbor {{ ibgp_peer.loopback }} soft-reconfiguration inbound
{% endif %}
{% endfor %}
{% endif %}
{% if peers is defined %}
{% for peer in peers %}
  neighbor {{ peer.peer_address }} activate
  neighbor {{ peer.peer_address }} soft-reconfiguration inbound
  neighbor {{ peer.peer_address }} route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 in
  neighbor {{ peer.peer_address }} route-map RM-DN42-PEER-OUT-V6 out
{% endfor %}
{% endif %}
 exit-address-family
exit
!
{% if isis_enabled | default(false) %}
router isis DN42
 net {{ isis_config.area_id | default('49') }}.0000.0000.{{ '%04d' | format(loopback.split('.')[-1] | int) }}.00
 is-type {{ isis_config.is_type | default('level-2-only') }}
 metric-style {{ isis_config.metric_style | default('wide') }}
{% if segment_routing_enabled | default(false) %}
 segment-routing on
{% if segment_routing_config.srgb_start is defined and segment_routing_config.srgb_end is defined %}
 segment-routing global-block {{ segment_routing_config.srgb_start }} {{ segment_routing_config.srgb_end }}
{% endif %}
 segment-routing node-msd {{ segment_routing_config.node_msd | default(8) }}
{% if segment_routing_config.index_method == 'last_octet' %}
 segment-routing prefix {{ loopback }}/32 index {{ loopback.split('.')[-1] }}{% if segment_routing_config.explicit_null | default(true) %} explicit-null{% endif %}

{% elif segment_routing_config.index_method == 'manual' and segment_routing_index is defined %}
 segment-routing prefix {{ loopback }}/32 index {{ segment_routing_index }}{% if segment_routing_config.explicit_null | default(true) %} explicit-null{% endif %}

{% endif %}
{% endif %}
exit
{% endif %}
!
{% if ospf_enabled | default(false) %}
router ospf
 ospf router-id {{ bgp_router_id | default(loopback) }}
{% if ospf_config.reference_bandwidth is defined %}
 auto-cost reference-bandwidth {{ ospf_config.reference_bandwidth }}
{% endif %}
{% if ospf_config.log_adjacency_changes | default(true) %}
 log-adjacency-changes
{% endif %}
{% if segment_routing_enabled | default(false) %}
 segment-routing on
{% if segment_routing_config.srgb_start is defined and segment_routing_config.srgb_end is defined %}
 segment-routing global-block {{ segment_routing_config.srgb_start }} {{ segment_routing_config.srgb_end }}
{% endif %}
 segment-routing node-msd {{ segment_routing_config.node_msd | default(8) }}
{% if segment_routing_config.index_method == 'last_octet' %}
 segment-routing prefix {{ loopback }}/32 index {{ loopback.split('.')[-1] }}{% if segment_routing_config.explicit_null | default(true) %} explicit-null{% endif %}

{% elif segment_routing_config.index_method == 'manual' and segment_routing_index is defined %}
 segment-routing prefix {{ loopback }}/32 index {{ segment_routing_index }}{% if segment_routing_config.explicit_null | default(true) %} explicit-null{% endif %}

{% endif %}
{% endif %}
exit
{% endif %}
!
{% if ip_prefix_lists is defined %}
{% for prefix_list in ip_prefix_lists %}
ip prefix-list {{ prefix_list.name }} seq {{ prefix_list.seq }} {{ prefix_list.action }} {{ prefix_list.prefix }}{% if prefix_list.ge is defined %} ge {{ prefix_list.ge }}{% endif %}{% if prefix_list.le is defined %} le {{ prefix_list.le }}{% endif %}

{% endfor %}
{% endif %}
!
{% if ipv6_prefix_lists is defined %}
{% for prefix_list in ipv6_prefix_lists %}
ipv6 prefix-list {{ prefix_list.name }} seq {{ prefix_list.seq }} {{ prefix_list.action }} {{ prefix_list.prefix }}{% if prefix_list.ge is defined %} ge {{ prefix_list.ge }}{% endif %}{% if prefix_list.le is defined %} le {{ prefix_list.le }}{% endif %}

{% endfor %}
{% endif %}
!
{% if bgp_as_path_acls is defined %}
{% for as_path_acl in bgp_as_path_acls %}
bgp as-path access-list {{ as_path_acl.name }} seq {{ as_path_acl.seq }} permit {{ as_path_acl.value }}
{% endfor %}
{% endif %}
!
{% if bgp_community_lists is defined %}
{% for community_list in bgp_community_lists %}
{% if community_list.seq is defined %}
bgp community-list {% if community_list.type is defined %}{{ community_list.type }}{% else %}standard{% endif %} {{ community_list.name }} seq {{ community_list.seq }} permit {{ community_list.value }}
{% else %}
bgp community-list {% if community_list.type is defined %}{{ community_list.type }}{% else %}expanded{% endif %} {{ community_list.name }} seq 5 permit {{ community_list.value }}
{% endif %}
{% endfor %}
{% endif %}
{% if bgp_large_community_lists is defined %}
{% for large_community_list in bgp_large_community_lists %}
bgp large-community-list expanded {{ large_community_list.name }} seq {{ large_community_list.seq }} permit {{ large_community_list.value }}
{% endfor %}
{% endif %}
!
{% if route_maps is defined %}
{% for route_map in route_maps %}
{% if route_map.entries is defined %}
{% for entry in route_map.entries %}
route-map {{ route_map.name }} {{ entry.action }} {{ entry.seq }}
{% if entry.match_prefix_list is defined %}
 match ip address prefix-list {{ entry.match_prefix_list }}
{% endif %}
{% if entry.match_ipv6_prefix_list is defined %}
 match ipv6 address prefix-list {{ entry.match_ipv6_prefix_list }}
{% endif %}
{% if entry.match_large_community is defined %}
 match large-community {{ entry.match_large_community }}
{% endif %}
exit
!
{% endfor %}
{% else %}
route-map {{ route_map.name }} {{ route_map.action }} {{ route_map.seq }}
{% if route_map.set_community is defined %}
 set community {{ route_map.set_community }}
{% endif %}
{% if route_map.set_large_community is defined %}
 set large-community {{ route_map.set_large_community }}
{% endif %}
exit
!
{% endif %}
{% endfor %}
{% endif %}
{% if peers is defined %}
{% for peer in peers %}
!
! Route-map for {{ peer.name }} (AS{{ peer.asn }}) - {{ peer.iso_3166_country_code }}/{{ peer.dn42_region }}
! Implements cold potato routing policy with geographic locality preferences
!
! IPv4 Ingress Policy
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 50
 description AS_PATH len=1 (direct peer) -> LPREF 300
 match as-path AS_PATH_LEN_1
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 300
 set metric {{ peer.latency_us }}
exit
!
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 60
 description Prefix country = Router country ({{ iso_3166_country_code }}) -> LPREF 230 (cold potato)
 match community CL-DN42-{{ iso_3166_country_code }}
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 230
 set metric {{ peer.latency_us }}
exit
!
{% if iso_3166_country_code != peer.iso_3166_country_code %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 70
 description Prefix country = Peer country ({{ peer.iso_3166_country_code }}) -> LPREF 220
 match community CL-DN42-{{ peer.iso_3166_country_code }}
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 220
 set metric {{ peer.latency_us }}
exit
!
{% endif %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 80
 description Prefix region = Router region ({{ dn42_region }}) -> LPREF 210
 match community CL-DN42-{{ dn42_region | upper }}
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 210
 set metric {{ peer.latency_us }}
exit
!
{% if dn42_region != peer.dn42_region %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 90
 description Prefix region = Peer region ({{ peer.dn42_region }}) -> LPREF 200
 match community CL-DN42-{{ peer.dn42_region | upper }}
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 200
 set metric {{ peer.latency_us }}
exit
!
{% endif %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN permit 100
 description Default (any DN42 prefix) -> LPREF 100
 match ip address prefix-list DN42-ALL
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 100
 set metric {{ peer.latency_us }}
exit
!
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN deny 1000
 description Explicit deny (non-DN42 prefixes)
exit
!
! IPv6 Ingress Policy (mirrors IPv4 policy)
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 50
 description AS_PATH len=1 (direct peer) -> LPREF 300
 match as-path AS_PATH_LEN_1
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 300
 set metric {{ peer.latency_us }}
exit
!
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 60
 description Prefix country = Router country ({{ iso_3166_country_code }}) -> LPREF 230 (cold potato)
 match community CL-DN42-{{ iso_3166_country_code }}
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 230
 set metric {{ peer.latency_us }}
exit
!
{% if iso_3166_country_code != peer.iso_3166_country_code %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 70
 description Prefix country = Peer country ({{ peer.iso_3166_country_code }}) -> LPREF 220
 match community CL-DN42-{{ peer.iso_3166_country_code }}
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 220
 set metric {{ peer.latency_us }}
exit
!
{% endif %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 80
 description Prefix region = Router region ({{ dn42_region }}) -> LPREF 210
 match community CL-DN42-{{ dn42_region | upper }}
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 210
 set metric {{ peer.latency_us }}
exit
!
{% if dn42_region != peer.dn42_region %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 90
 description Prefix region = Peer region ({{ peer.dn42_region }}) -> LPREF 200
 match community CL-DN42-{{ peer.dn42_region | upper }}
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 200
 set metric {{ peer.latency_us }}
exit
!
{% endif %}
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 permit 100
 description Default (any DN42 prefix) -> LPREF 100
 match ipv6 address prefix-list DN42-ALL-V6
 set large-community {{ ingress_bgp_large_community }}
 set local-preference 100
 set metric {{ peer.latency_us }}
exit
!
route-map RM-DN42-PEER-{{ peer.dn42_region | upper }}-{{ peer.iso_3166_country_code }}-{{ peer.name }}-IN-V6 deny 1000
 description Explicit deny (non-DN42 prefixes)
exit
!
{% endfor %}
{% endif %}
